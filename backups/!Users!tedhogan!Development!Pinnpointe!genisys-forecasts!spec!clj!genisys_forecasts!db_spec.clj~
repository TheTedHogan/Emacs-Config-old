(ns genisys-forecasts.db-spec
  (:require [speclj.core :refer :all]
            [genisys-forecasts.db :as db]
            [genisys-forecasts.utility :refer [db-fixture
                                               install-fixture
                                               setup-db]]))
(defn setup []
  [(before-all
    (db/setup-db (get-pool)))
   (before
    (install-fixture))])

(describe "transactions" 
          (setup)

          (it "Rolls back when instruted"
              (db/in-transaction
               (fn []
                 (db/set-rollback)
                 (db/insert! :companies {:name "Test"})))
              (should-be empty? (db/query "select * from companies where name='Test'")))
          (it "Commits by default"
              (db/in-transaction
               (fn []
                 (db/insert! :companies {:name "Test"})))
              (should-not-be-empty? (db/query "select * from companies where name='Test'"))))

(describe "get-principals"
          (setup)
          
          (it "Gets all Principals"
              (should= (count (db/get-principals)) (count (:principals db-fixture)))))

(describe "get-customers"
          (setup)
         
          (it "Gets all Customer Groups"
              (should= (count (db/get-customers)) (count (:customergroups db-fixture)))))

(describe "get-busmans"
          (setup)
          
          (it "Gets all Business Managers"
              (should= (count (db/get-busmans)) (count (filter #(= "yes" (:bm %)) (:employees db-fixture))))))

(describe "get-divisions"
          (setup)
          
          (it "Gets all Divisions"
              (should= (count (db/get-divisions)) (count (:divisions db-fixture)))))

(run-specs)
